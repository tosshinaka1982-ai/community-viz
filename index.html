<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Analysis POC</title>
  <style>
    body {
      font-family: system-ui;
      margin: 20px;
      line-height: 1.5;
    }
    textarea { width: 100%; min-height: 120px; margin-top: 8px; }
    button { padding: 8px 16px; margin-top: 8px; }
    pre { background: #f7f7f7; padding: 12px; border-radius: 8px; white-space: pre-wrap; }
  </style>
</head>
<body>

  <h2>AI分析ウィンドウ（POC）</h2>
  <textarea id="q" placeholder="例：2025年下期で増患が多かった拠点を分析して"></textarea>
  <br>
  <button id="run">AI分析</button>
  <pre id="out">（ここに結果が出ます）</pre>

  <!-- ✅ seed-data（データ埋め込み） -->
<script type="application/json" id="seed-data">
{
  "schema": ["拠点名","25/04","25/05","25/06","25/07","25/08","25/09","25/10","25/11","総計"],
  "rows": [
    ["あげお", null,  null,  35, 24, 22, 10, 12, null, 103],
    ["そよ風", 25,    44,    57, 75, 77, 73, 34, 1,   386],
    ["そよ風・白石",29,    23,    25, 30, 67, 13, 18, null,205],
    ["プリム", null,  null,  null,null,19, 13, 18, 10, 60],
    ["伊勢崎",34,    25,    44, 24, 31, 28, 22, null,208],
    ["吉田",  45,    38,    43, 34, 44, 46, 23, 1,   274],
    ["吉田名西",null,null,  null,null,null,19, 22, 14, 55],
    ["国分寺",10,    11,    6,  6,  6,  9,  4,  null,52],
    ["堺",    12,    12,    10, 11, 10, 8,  6,  null,69],
    ["札幌",  null,  null,  null,null,null,null,8,  null,8],
    ["市原",  20,    64,    18, 15, 7,  25, 7,  null,156],
    ["市川",  14,    24,    15, 19, 14, 15, 4,  4,   109],
    ["守谷",  19,    12,    23, 22, 14, 5,  null,null,95],
    ["青野",  17,    13,    34, 19, 7,  14, 3,  null,107],
    ["摂津",  2,     5,     4,  5,  3,  6,  5,  null,30],
    ["仙台",  5,     5,     21, 19, 32, 38, 25, null,145],
    ["前橋",  35,    21,    28, 29, 22, 33, 19, null,187],
    ["蘇我",  37,    30,    35, 28, 2,  null,null,null,132],
    ["町田",  27,    25,    16, 17, 15, 28, 13, null,141],
    ["天王町",50,    22,    28, 36, 48, 21, null,null,205],
    ["南増尾",null,  null,  null,null,16, 7,  null,null,23],
    ["日立",  4,     15,    8,  12, 10, 12, 9,  null,70],
    ["八潮",  null,  null,  null,null,23, 19, 21, 18, 81],
    ["府中",  5,     6,     11, 12, 7,  12, null,null,53],
    ["豊橋",  13,    7,     10, 10, 14, 13, 3,  null,70]
  ]
}
</script>
  
  <!-- ✅ AI分析スクリプト -->
  <script>
  const GEMINI_API_KEY = "AIzaSyB1Qf-xLUvF6NZpGXl9r4EHEhNyKrvdXTk"; // ← 差し替え

<script>
// ▼ 今日だけ使うAPIキー（実験後は必ず無効化/削除）
const GEMINI_API_KEY = "AIzaSyB1Qf-xLUvF6NZpGXl9r4EHEhNyKrvdXTk"; // ←差し替え

async function callGemini(prompt, model = "gemini-2.5-pro") {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
  const payload = { contents: [{ role: "user", parts: [{ text: prompt }]}] };

  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  // 失敗時は本文も返して原因を見える化
  if (!res.ok) {
    const body = await res.text();
    console.error("Gemini error", res.status, body);
    throw new Error(`Gemini HTTP ${res.status}\n${body}`);
  }

  const json = await res.json();
  const text = json?.candidates?.[0]?.content?.parts?.[0]?.text;
  return text || "(応答なし)";
}

// （任意）seed-data を要約して AI に文脈として渡す
function seedSummaryForPrompt() {
  const el = document.getElementById("seed-data");
  if (!el) return "";
  const json = JSON.parse(el.textContent);
  const head = json.schema || [];
  const rows = json.rows || [];
  const iSite = 0;

  // "25/04" のような列を抽出
  const monthCols = head.map((h,i)=>({h,i})).filter(c => /^\d{2}\/\d{2}$/.test(c.h));
  let total = 0;
  const bySite = {};

  for (const r of rows) {
    const site = String(r[iSite]||"").trim();
    if (!site) continue;
    let s = 0;
    for (const c of monthCols) {
      const v = r[c.i];
      if (v == null || v === "") continue;
      const n = Number(v) || 0;
      s += n; total += n;
    }
    if (s) bySite[site] = (bySite[site] || 0) + s;
  }

  const top = Object.entries(bySite).sort((a,b)=>b[1]-a[1]).slice(0,3)
               .map(([k,v])=>`${k}:${v}`).join(", ");
  return `期間合計:${total} / 上位拠点:${top}`;
}

document.getElementById("run").onclick = async () => {
  const q = (document.getElementById("q").value || "").trim();
  const out = document.getElementById("out");
  if (!q) { out.textContent = "テキストを入力してください。"; return; }

  // LookerのURLクエリで期間が付いていれば表示用に使う
  const p = new URLSearchParams(location.search);
  const start = p.get("start") || "(未指定)";
  const end   = p.get("end")   || "(未指定)";

  // seed-data の軽要約をプロンプトに添付（任意）
  const summary = seedSummaryForPrompt();

  const fullPrompt = [
    "あなたはBIダッシュボードのアナリストです。",
    `対象期間: ${start} ～ ${end}`,
    summary ? `データ要約: ${summary}` : "",
    `ユーザー入力: ${q}`,
    "矛盾があれば指摘し、簡潔に洞察と次のアクションを示してください。"
  ].filter(Boolean).join("\n");

  out.textContent = "分析中…";
  try {
    const text = await callGemini(fullPrompt);
    out.textContent = text;
  } catch (e) {
    out.textContent = "エラー:\n" + e.message;
  }
};
</script>
