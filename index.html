<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Analysis Window (Minimal)</title>
<style>
  :root { --bg:#fff; --muted:#f7f7f7; --pill:#eef; --text:#111; --accent:#0a66cc; }
  html,body{margin:0;height:100%;font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;background:var(--bg);color:var(--text)}
  .wrap{padding:12px;box-sizing:border-box;max-width:960px;margin:0 auto}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-block;background:var(--pill);border-radius:999px;padding:2px 8px;font-size:12px}
  textarea{width:100%;min-height:120px;margin-top:8px;padding:10px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
  pre{white-space:pre-wrap;background:var(--muted);padding:12px;border-radius:8px;margin:8px 0 0}
  button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  button.ghost{background:#e7edf3;color:#083b6d}
  #panel.min{max-height:40px;overflow:hidden}
  #panel.hide{display:none}
</style>

<div class="wrap">
  <h3 style="margin:0 0 8px">AI Analysis Window</h3>

  <!-- 表示/縮小/非表示 -->
  <div class="row" style="margin:6px 0 10px">
    <button id="toggle">▼ 表示/縮小/非表示</button>
    <span id="state" class="pill">表示中</span>
    <span id="ctx" class="pill"></span>
  </div>

  <div id="panel">
    <textarea id="q" placeholder="このダッシュボードの傾向を要約して（例：KPIの増減理由、要注意拠点、今月のリスクなど）"></textarea>
    <div class="row" style="margin-top:6px">
      <select id="mode">
        <option value="brief">ブリーフ（短く）</option>
        <option value="detailed">詳細（箇条書き）</option>
      </select>
      <button id="run">AI分析</button>
      <button id="clear" class="ghost">クリア</button>
    </div>
    <h4 style="margin:12px 0 4px">結果</h4>
    <pre id="out">（ここに結果）</pre>
  </div>
</div>

<script>
  // ▼ 表示/縮小/非表示
  const panel = document.getElementById('panel');
  const stateEl = document.getElementById('state');
  const toggle = document.getElementById('toggle');
  let modeView = 'show'; // show -> min -> hide
  function applyMode(){
    panel.classList.remove('min','hide');
    if(modeView==='show'){ stateEl.textContent='表示中'; toggle.textContent='▼ 表示/縮小/非表示';}
    else if(modeView==='min'){ panel.classList.add('min'); stateEl.textContent='縮小中'; toggle.textContent='◧ 再展開/非表示';}
    else { panel.classList.add('hide'); stateEl.textContent='非表示'; toggle.textContent='▲ 再表示';}
  }
  toggle.onclick = ()=>{ modeView = (modeView==='show')?'min':(modeView==='min')?'hide':'show'; applyMode(); };
  applyMode();

  // 解析モード（擬似要約：フロントだけで動く簡易ロジック）
  const qEl = document.getElementById('q');
  const out = document.getElementById('out');
  const sel = document.getElementById('mode');
  const clearBtn = document.getElementById('clear');
  clearBtn.onclick = ()=>{ qEl.value=''; out.textContent='（ここに結果）'; };

  // LookerのURL埋め込みから期間などを拾って表示（任意）
  const params = new URLSearchParams(location.search);
  const start = params.get('start');
  const end   = params.get('end');
  const ctx   = document.getElementById('ctx');
  ctx.textContent = (start || end) ? `期間: ${(start||'…')} ～ ${(end||'…')}` : '期間: (未指定)';

  // 簡易“要約”生成（クライアント側のみ／外部API不使用）
  function summarize(text, style){
    const t = (text||'').trim();
    if(!t) return 'テキストを入力してください。';
    const lines = t.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const bullets = lines.slice(0,6).map((s,i)=>`- ${s}`);
    if(style==='brief'){
      return `【サマリ】\n` + (lines[0]?.slice(0,120) || '入力が短すぎます。');
    } else {
      return `【主要ポイント】\n` + bullets.join('\n') +
        `\n\n【次のアクション（例）】\n- 指標の変化が大きいディメンションを深掘り\n- 直近週の異常値をコメント付与\n- 来月のリスク/仮説を1つ書き出し`;
    }
  }

  document.getElementById('run').onclick = ()=>{
    const text = qEl.value;
    const style = sel.value;
    out.textContent = summarize(text, style);
  };
</script>
